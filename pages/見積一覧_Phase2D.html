<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QURURi – 見積一覧</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #f5f6f8;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f1f4;
    --bg-card: #ffffff;
    --border-subtle: #e8eaed;
    --border-default: #d4d7dd;
    --border-focus: rgba(55,110,230,0.45);
    --text-primary: #1a1d26;
    --text-secondary: #5f6577;
    --text-tertiary: #9198a8;
    --text-label: #6e7585;
    --accent-blue: #376ee6;
    --accent-blue-glow: #eef3fc;
    --danger: #d9503f;
    --danger-bg: #fdf0ee;
    --success: #1a8f5c;
    --success-bg: #edf8f2;
    --warning: #d97706;
    --warning-bg: #fffbeb;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 18px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Noto Sans JP', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .app-shell {
    display: flex;
    min-height: 100vh;
    padding-left: 240px;
  }

  /* ─── Sidebar ─── */
  .sidebar {
    width: 240px;
    background: #1a1d26;
    padding: 24px 0;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0; left: 0;
    height: 100vh;
    overflow-y: auto;
    z-index: 100;
  }

  .sidebar-logo { padding: 0 20px; margin-bottom: 32px; }
  .sidebar-logo-main { font-size: 20px; font-weight: 700; letter-spacing: 1px; color: #fff; margin-bottom: 4px; }
  .sidebar-logo-sub { font-size: 11px; font-weight: 500; color: #9ca3af; letter-spacing: 0.5px; }

  .sidebar-nav { flex: 1; padding: 0; }

  .nav-section-label {
    padding: 0 20px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: #d1d5db;
    margin: 16px 0 6px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 400;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.15s;
    border-left: 3px solid transparent;
    background: none;
    border-right: none;
    border-top: none;
    border-bottom: none;
    width: 100%;
    text-align: left;
    text-decoration: none;
  }
  .nav-item:hover { color: #e5e7eb; background: rgba(255,255,255,0.05); }
  .nav-item.active { color: #ffffff; background: rgba(255,255,255,0.15); border-left-color: #60a5fa; font-weight: 600; }
  .nav-item svg { width: 18px; height: 18px; opacity: 0.8; flex-shrink: 0; }
  .nav-item.active svg { opacity: 1; }

  .sidebar-divider { border: none; border-top: 1px solid rgba(255,255,255,0.08); margin: 10px 20px; }

  /* ─── Main ─── */
  main { flex: 1; padding: 32px; min-width: 0; }

  .content-wrapper { max-width: 1400px; margin: 0 auto; }

  /* ─── Page Header ─── */
  .page-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 24px; gap: 16px; flex-wrap: wrap;
  }
  .page-title-group h1 {
    font-size: 22px; font-weight: 700; color: var(--text-primary);
    display: flex; align-items: center; gap: 10px; margin-bottom: 4px;
  }
  .page-subtitle { font-size: 13px; color: var(--text-secondary); }
  .header-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

  /* ─── Buttons ─── */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 8px 14px; border-radius: var(--radius-sm);
    font-size: 13px; font-weight: 500; cursor: pointer;
    transition: all 0.15s; border: 1px solid transparent; white-space: nowrap;
  }
  .btn svg { width: 14px; height: 14px; }
  .btn-primary { background: var(--accent-blue); color: #fff; }
  .btn-primary:hover { background: #2558cc; }
  .btn-secondary { background: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-default); }
  .btn-secondary:hover { background: var(--bg-tertiary); color: var(--text-primary); }
  .btn-ghost { background: transparent; color: var(--text-secondary); border-color: transparent; }
  .btn-ghost:hover { background: var(--bg-tertiary); }

  /* ─── Summary Bar ─── */
  .summary-bar {
    display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
  }
  .summary-card {
    background: var(--bg-card); border-radius: var(--radius-md);
    padding: 14px 20px; border: 1px solid var(--border-subtle);
    min-width: 160px; flex: 1;
  }
  .summary-card.highlight { border-color: var(--accent-blue); }
  .summary-label { font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .summary-value { font-size: 22px; font-weight: 700; color: var(--text-primary); font-variant-numeric: tabular-nums; }
  .summary-card.highlight .summary-value { color: var(--accent-blue); }
  .summary-sub { font-size: 11px; color: var(--text-tertiary); margin-top: 2px; }

  /* ─── Filter Card ─── */
  .filter-card {
    background: var(--bg-card); border-radius: var(--radius-lg);
    padding: 16px; border: 1px solid var(--border-subtle);
    margin-bottom: 16px; display: flex; flex-direction: column; gap: 12px;
  }
  .filter-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .filter-label { font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
  .search-wrap {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg-tertiary); border: 1px solid var(--border-subtle);
    border-radius: var(--radius-sm); padding: 6px 12px; flex: 1; min-width: 200px;
  }
  .search-wrap svg { width: 14px; height: 14px; color: var(--text-tertiary); flex-shrink: 0; }
  .search-input { border: none; background: transparent; font-size: 13px; color: var(--text-primary); outline: none; width: 100%; }
  .filter-select {
    border: 1px solid var(--border-default); border-radius: var(--radius-sm);
    padding: 7px 10px; font-size: 13px; color: var(--text-primary);
    background: var(--bg-secondary); cursor: pointer; min-width: 130px;
  }
  .filter-date-range { display: flex; align-items: center; gap: 6px; }
  .filter-date-range input[type="date"] {
    border: 1px solid var(--border-default); border-radius: var(--radius-sm);
    padding: 7px 10px; font-size: 13px; color: var(--text-primary);
  }

  /* ─── Table Card ─── */
  .table-card {
    background: var(--bg-card); border-radius: var(--radius-lg);
    border: 1px solid var(--border-subtle); overflow: hidden;
  }
  .table-toolbar {
    padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);
    display: flex; justify-content: space-between; align-items: center; gap: 12px;
  }
  .table-count { font-size: 13px; color: var(--text-secondary); }
  .table-count strong { color: var(--text-primary); }
  .table-wrap { overflow-x: auto; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { background: var(--bg-tertiary); }
  th {
    padding: 10px 12px; text-align: left;
    font-size: 11px; font-weight: 600; letter-spacing: 0.3px;
    color: var(--text-secondary); white-space: nowrap; cursor: pointer;
    border-bottom: 1px solid var(--border-subtle); user-select: none;
  }
  th:hover { color: var(--text-primary); }
  .sort-icon { opacity: 0.4; font-size: 10px; }
  .sort-asc .sort-icon { opacity: 1; }
  .sort-desc .sort-icon { opacity: 1; }

  td { padding: 10px 12px; border-bottom: 1px solid var(--border-subtle); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tbody tr:hover { background: var(--accent-blue-glow); }

  .row-checkbox { cursor: pointer; accent-color: var(--accent-blue); width: 15px; height: 15px; }

  .est-no-link {
    color: var(--accent-blue); font-weight: 600; font-family: 'Inter', monospace;
    cursor: pointer; text-decoration: none; font-size: 12px;
  }
  .est-no-link:hover { text-decoration: underline; }

  .proj-no-link {
    color: var(--text-secondary); font-size: 11px; font-family: 'Inter', monospace;
    cursor: pointer;
  }
  .proj-no-link:hover { color: var(--accent-blue); text-decoration: underline; }

  /* ─── Status Badges ─── */
  .status-badge {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 9px; border-radius: 12px;
    font-size: 11px; font-weight: 600; white-space: nowrap;
  }
  .status-badge::before {
    content: ''; width: 5px; height: 5px; border-radius: 50%;
    background: currentColor; flex-shrink: 0;
  }
  .status-draft     { background: #f0f1f4; color: #6e7585; }
  .status-quoted    { background: #fffbeb; color: #d97706; }
  .status-ordered   { background: #edf8f2; color: #1a8f5c; }
  .status-delivered { background: var(--accent-blue-glow); color: var(--accent-blue); }
  .status-invoiced  { background: #f3f0ff; color: #7c3aed; }
  .status-paid      { background: #f0f9f0; color: #15803d; }

  .prob-badge {
    display: inline-flex; align-items: center; justify-content: center;
    min-width: 44px; padding: 2px 8px; border-radius: 12px;
    font-size: 11px; font-weight: 700; font-family: 'Inter', sans-serif;
  }

  .currency-badge {
    display: inline-block; font-size: 10px; font-weight: 600;
    color: var(--text-tertiary); background: var(--bg-tertiary);
    border-radius: 4px; padding: 1px 4px;
    font-family: 'Inter', sans-serif;
  }

  .selected-row { background: #f0f5ff !important; }
  .prod-subrow td { border-top: 1px dashed var(--border-subtle); }

  .td-date { font-family: 'Inter', sans-serif; font-size: 12px; }
  .date-overdue { color: var(--danger); font-weight: 600; }
  .date-soon { color: var(--warning); }

  /* ─── Status Badge ─── */
  .status-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 9px; border-radius: 99px;
    font-size: 11px; font-weight: 600; white-space: nowrap;
  }
  .status-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
  .status-pending   { color: #d97706; background: #fffbeb; }
  .status-quoted    { color: #376ee6; background: #eef3fc; }

  /* ─── Probability Bar ─── */
  .prob-bar-wrap { display: flex; align-items: center; gap: 8px; }
  .prob-bar { height: 4px; background: var(--border-subtle); border-radius: 2px; flex: 1; min-width: 50px; }
  .prob-fill { height: 100%; border-radius: 2px; background: var(--accent-blue); transition: width 0.3s; }
  .prob-pct { font-size: 12px; color: var(--text-secondary); font-variant-numeric: tabular-nums; min-width: 32px; text-align: right; }

  /* ─── Empty State ─── */
  .empty-state {
    text-align: center; padding: 60px 20px; color: var(--text-tertiary);
  }
  .empty-state svg { width: 48px; height: 48px; opacity: 0.3; margin-bottom: 16px; }
  .empty-state h3 { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
  .empty-state p { font-size: 13px; }

  /* ─── Pagination ─── */
  .pagination { display: flex; justify-content: center; gap: 6px; padding: 16px; align-items: center; }
  .page-btn {
    width: 32px; height: 32px; border-radius: var(--radius-sm); border: 1px solid var(--border-default);
    background: var(--bg-secondary); cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .page-btn:hover { background: var(--bg-tertiary); }
  .page-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); font-weight: 600; }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* ─── Bulk Bar ─── */
  .bulk-bar {
    display: none; align-items: center; gap: 8px;
    background: #eef3fc; border: 1px solid #c7d7f5;
    border-radius: var(--radius-sm); padding: 4px 10px; font-size: 12px; color: var(--accent-blue);
  }
  .bulk-bar.show { display: flex; }
  .bulk-bar svg { width: 14px; height: 14px; }

  .per-page-select {
    border: 1px solid var(--border-default); border-radius: var(--radius-sm);
    padding: 5px 8px; font-size: 12px; color: var(--text-secondary); background: var(--bg-secondary);
  }

  /* ─── Modal ─── */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.45); z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg-card); border-radius: var(--radius-xl);
    padding: 28px; width: 560px; max-width: 95vw; max-height: 90vh; overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .modal-title { font-size: 16px; font-weight: 700; }
  .modal-close { background: none; border: none; cursor: pointer; color: var(--text-secondary); padding: 4px; border-radius: var(--radius-sm); }
  .modal-close:hover { background: var(--bg-tertiary); }
  .modal-close svg { width: 18px; height: 18px; }
  .modal-body { display: flex; flex-direction: column; gap: 16px; }
  .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }

  .upload-zone {
    border: 2px dashed var(--border-default); border-radius: var(--radius-md);
    padding: 32px; text-align: center; cursor: pointer; transition: all 0.15s;
  }
  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--accent-blue); background: var(--accent-blue-glow);
  }
  .upload-zone svg { width: 36px; height: 36px; color: var(--text-tertiary); margin-bottom: 10px; }
  .upload-zone p { font-size: 13px; color: var(--text-secondary); }
  .upload-zone .upload-hint { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; }

  .import-preview {
    background: var(--bg-tertiary); border-radius: var(--radius-sm);
    padding: 12px; font-size: 12px; color: var(--text-secondary);
    max-height: 200px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;
  }

  /* ─── Toast ─── */
  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; border-radius: var(--radius-md);
    font-size: 13px; font-weight: 500; min-width: 280px; max-width: 400px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateX(120%); transition: transform 0.25s ease;
  }
  .toast.show { transform: translateX(0); }
  .toast.success { background: var(--success); color: #fff; }
  .toast.error   { background: var(--danger); color: #fff; }
  .toast.info    { background: var(--accent-blue); color: #fff; }
  .toast-icon { font-size: 15px; }
</style>
</head>
<body>
<div class="app-shell">

  <!-- ─── Sidebar ─── -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-main">QURURi</div>
      <div class="sidebar-logo-sub">Your INTELLIGENCE</div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section-label">案件管理</div>
      <div class="nav-item" onclick="showToast('ダッシュボードは準備中です', 'info')" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        ダッシュボード
      </div>
      <div class="nav-item" onclick="window.location.href='案件入力画面_Phase2A_連携版.html'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
        案件入力
      </div>
      <div class="nav-item" onclick="window.location.href='案件一覧_Phase2B.html'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="9" x2="9" y2="21"/></svg>
        案件一覧
      </div>
      <div class="nav-item active">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        見積一覧
      </div>
      <hr class="sidebar-divider">
      <div class="nav-section-label">マスター管理</div>
      <div class="nav-item" id="nav-products" onclick="location.href='マスター管理画面_Phase2C.html?tab=products'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        製品マスタ
        <span id="sidebar-badge-products" style="margin-left:auto;font-size:10px;background:rgba(255,255,255,0.15);color:#e5e7eb;border-radius:10px;padding:1px 7px;min-width:24px;text-align:center;display:none;"></span>
      </div>
      <div class="nav-item" id="nav-prices" onclick="location.href='マスター管理画面_Phase2C.html?tab=prices'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        単価マスタ
        <span id="sidebar-badge-prices" style="margin-left:auto;font-size:10px;background:rgba(255,255,255,0.15);color:#e5e7eb;border-radius:10px;padding:1px 7px;min-width:24px;text-align:center;display:none;"></span>
      </div>
      <div class="nav-item" id="nav-exchange_rates" onclick="location.href='マスター管理画面_Phase2C.html?tab=exchange_rates'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        為替マスタ
        <span id="sidebar-badge-exchange_rates" style="margin-left:auto;font-size:10px;background:rgba(255,255,255,0.15);color:#e5e7eb;border-radius:10px;padding:1px 7px;min-width:24px;text-align:center;display:none;"></span>
      </div>
      <div class="nav-item" id="nav-customers" onclick="location.href='マスター管理画面_Phase2C.html?tab=customers'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        取引先マスタ
        <span id="sidebar-badge-customers" style="margin-left:auto;font-size:10px;background:rgba(255,255,255,0.15);color:#e5e7eb;border-radius:10px;padding:1px 7px;min-width:24px;text-align:center;display:none;"></span>
      </div>
      <div class="nav-item" id="nav-staff" onclick="location.href='マスター管理画面_Phase2C.html?tab=staff'" style="cursor:pointer">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        担当者マスタ
        <span id="sidebar-badge-staff" style="margin-left:auto;font-size:10px;background:rgba(255,255,255,0.15);color:#e5e7eb;border-radius:10px;padding:1px 7px;min-width:24px;text-align:center;display:none;"></span>
      </div>
    </nav>
  </aside>

  <!-- ─── Main ─── -->
  <main>
    <div class="content-wrapper">

      <!-- Page Header -->
      <div class="page-header">
        <div class="page-title-group">
          <h1>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:22px;height:22px;color:var(--accent-blue)"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            見積一覧
          </h1>
          <p class="page-subtitle">見積申請済みの案件一覧。EST番号をクリックして案件を確認。CSVで一括登録も可能（PJ自動生成）。</p>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="openImportModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            CSVインポート
          </button>
          <button class="btn btn-secondary" onclick="exportCSV()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            CSVエクスポート
          </button>
        </div>
      </div>

      <!-- Summary Bar -->
      <div class="summary-bar">
        <div class="summary-card highlight">
          <div class="summary-label">表示件数</div>
          <div class="summary-value" id="sumCount">–</div>
          <div class="summary-sub">件</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">合計金額（税抜）</div>
          <div class="summary-value" id="sumTotal">–</div>
          <div class="summary-sub">円</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">受注確度加重平均</div>
          <div class="summary-value" id="sumProb">–</div>
          <div class="summary-sub">期待値</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">最新申請日</div>
          <div class="summary-value" id="sumLatest" style="font-size:16px;">–</div>
          <div class="summary-sub" id="sumLatestLabel">–</div>
        </div>
      </div>

      <!-- Filter Area -->
      <div class="filter-card">
        <div class="filter-row">
          <div class="search-wrap">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" class="search-input" id="searchInput" placeholder="EST番号・案件名・取引先で検索..." oninput="applyFilters()">
          </div>
          <select class="filter-select" id="filterRegion" onchange="applyFilters()">
            <option value="">地域: 全て</option>
          </select>
          <select class="filter-select" id="filterSales" onchange="applyFilters()">
            <option value="">担当者: 全て</option>
          </select>
          <button class="btn btn-secondary" onclick="clearFilters()" style="margin-left:auto;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            リセット
          </button>
        </div>
        <div class="filter-row">
          <span class="filter-label">申請日：</span>
          <div class="filter-date-range">
            <input type="date" id="filterDateFrom" onchange="applyFilters()">
            <span class="filter-label">〜</span>
            <input type="date" id="filterDateTo" onchange="applyFilters()">
          </div>
          <select class="filter-select" id="filterProb" onchange="applyFilters()" style="min-width:140px;">
            <option value="">確度: 全て</option>
            <option value="high">高（70%以上）</option>
            <option value="mid">中（40-69%）</option>
            <option value="low">低（39%以下）</option>
          </select>
        </div>
      </div>

      <!-- Table Card -->
      <div class="table-card">
        <div class="table-toolbar">
          <div style="display:flex;align-items:center;gap:12px;">
            <span class="table-count">
              <span id="resultCount">0</span>件中 <strong id="showingCount">0</strong>件表示
            </span>
            <div class="bulk-bar" id="bulkBar">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
              <span id="bulkCount">0</span>件選択中
              <button class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" onclick="exportSelectedCSV()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                選択分をエクスポート
              </button>
              <button class="btn" style="padding:4px 10px;font-size:12px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;" onclick="deleteSelected()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/></svg>
                選択削除
              </button>
            </div>
          </div>
          <div>
            <select class="per-page-select" id="perPageSelect" onchange="changePerPage()">
              <option value="20">20件表示</option>
              <option value="50">50件表示</option>
              <option value="100">100件表示</option>
              <option value="0">全件表示</option>
            </select>
          </div>
        </div>

        <div class="table-wrap">
          <table id="estTable">
            <thead>
              <tr>
                <th style="width:36px;padding:10px 12px;">
                  <input type="checkbox" class="row-checkbox" id="checkAll" onchange="toggleCheckAll()">
                </th>
                <th onclick="sortBy('estimate_no')">EST番号 <span class="sort-icon" id="sort_estimate_no">↕</span></th>
                <th onclick="sortBy('project_no')">案件No <span class="sort-icon" id="sort_project_no">↕</span></th>
                <th onclick="sortBy('projectName')">案件名 <span class="sort-icon" id="sort_projectName">↕</span></th>
                <th onclick="sortBy('customer')">取引先 <span class="sort-icon" id="sort_customer">↕</span></th>
                <th onclick="sortBy('status')">ステータス <span class="sort-icon" id="sort_status">↕</span></th>
                <th style="text-align:center;">地域</th>
                <th>製品名</th>
                <th style="text-align:center;">数量</th>
                <th style="text-align:center;">通貨</th>
                <th style="text-align:right;">明細金額</th>
                <th onclick="sortBy('subtotal')" style="text-align:right;">合計金額（税抜） <span class="sort-icon" id="sort_subtotal">↕</span></th>
                <th onclick="sortBy('probability')" style="text-align:center;">確度 <span class="sort-icon" id="sort_probability">↕</span></th>
                <th onclick="sortBy('deliveryDate')">納品予定日 <span class="sort-icon" id="sort_deliveryDate">↕</span></th>
                <th onclick="sortBy('salesPerson')">担当者 <span class="sort-icon" id="sort_salesPerson">↕</span></th>
                <th onclick="sortBy('issue_date')">申請日 <span class="sort-icon" id="sort_issue_date">↕</span></th>
                <th onclick="sortBy('version')" style="text-align:center;">版 <span class="sort-icon" id="sort_version">↕</span></th>
              </tr>
            </thead>
            <tbody id="estTableBody">
              <tr>
                <td colspan="17">
                  <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
                    <h3>見積データがありません</h3>
                    <p>案件入力画面で「見積申請」を実行するか、CSVインポートで一括登録してください。</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>

    </div>
  </main>
</div>

<!-- ─── CSVインポート モーダル ─── -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">見積CSVインポート</span>
      <button class="modal-close" onclick="closeImportModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--text-secondary);">
        CSVファイルをインポートします。<strong>PJレコードが自動生成</strong>され、見積一覧・案件一覧の両方に表示されます。
      </p>
      <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFileInput').click()">
        <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        <p>クリックしてCSVファイルを選択</p>
        <p class="upload-hint">またはファイルをここにドラッグ&ドロップ</p>
      </div>
      <div id="importPreview" style="display:none;">
        <p style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:6px;" id="previewTitle"></p>
        <div class="import-preview" id="previewContent"></div>
      </div>
      <div style="font-size:11px;color:var(--text-tertiary);line-height:1.7;">
        <strong>CSVフォーマット（必須列）：</strong>案件名、取引先コードまたは取引先名<br>
        <strong>任意列：</strong>担当者コード, 担当者名, 製品コード, 製品名, 数量, 納品予定日, 受注確度, ステータス, 金額, 備考<br>
        <strong>ステータス値：</strong>draft / quoted / ordered / delivered / invoiced / paid<br>
        <button onclick="downloadTemplate()" style="background:none;border:none;color:var(--accent-blue);cursor:pointer;font-size:11px;padding:4px 0;text-decoration:underline;">
          テンプレートCSVをダウンロード
        </button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeImportModal()">キャンセル</button>
      <button class="btn btn-primary" id="importExecuteBtn" onclick="executeImport()" disabled>
        インポート実行
      </button>
    </div>
  </div>
</div>

<!-- ─── Toast ─── -->
<div class="toast-container" id="toastContainer"></div>

<script>
// ===================================================
// QURURi 見積一覧 Phase 2D
// ===================================================

// ─── Storage Keys ───
const EST_KEY = 'qururi_estimates';
const PROJ_KEY_PREFIX = 'qururi_project_';
const PROJ_INDEX_KEY = 'qururi_projectIndex';

// ─── State ───
let allEstimates = [];
let filtered = [];
let currentPage = 1;
let perPage = 20;
let sortKey = 'issue_date';
let sortDir = 'desc';
let selectedRows = new Set();
let parsedCsvRows = [];

// ─── LocalDB (同一キー互換) ───
const LocalDB = {
  _getIndex() { try { return JSON.parse(localStorage.getItem(PROJ_INDEX_KEY)||'[]'); } catch { return []; } },
  _updateIndex(no) { const i=this._getIndex(); if(!i.includes(no)){i.push(no);localStorage.setItem(PROJ_INDEX_KEY,JSON.stringify(i));} },
  _generateNo() {
    const year=new Date().getFullYear();
    const all=this.getAllProjects();
    const max=all.filter(p=>p.projectNo?.startsWith(`PJ-${year}`))
      .reduce((m,p)=>Math.max(m,parseInt(p.projectNo?.slice(7))||0),0);
    return `PJ-${year}${String(max+1).padStart(4,'0')}`;
  },
  getAllProjects() {
    return this._getIndex()
      .map(no=>{try{return JSON.parse(localStorage.getItem(`${PROJ_KEY_PREFIX}${no}`));}catch{return null;}})
      .filter(Boolean);
  },
  saveProject(data) {
    if(!data.projectNo){data.projectNo=this._generateNo();data.createdAt=new Date().toISOString();}
    data.updatedAt=new Date().toISOString();
    localStorage.setItem(`${PROJ_KEY_PREFIX}${data.projectNo}`,JSON.stringify(data));
    this._updateIndex(data.projectNo);
    return data;
  },
};

// ─── EstimateDB ───
const EstimateDB = {
  getAll() { try { return JSON.parse(localStorage.getItem(EST_KEY)||'[]'); } catch { return []; } },
  save(est) {
    const all = this.getAll();
    const idx = all.findIndex(e=>e.estimate_no===est.estimate_no);
    if(idx>=0) all[idx]=est; else all.push(est);
    localStorage.setItem(EST_KEY, JSON.stringify(all));
    return est;
  },
  delete(estNo) {
    const all = this.getAll().filter(e=>e.estimate_no!==estNo);
    localStorage.setItem(EST_KEY, JSON.stringify(all));
  },
};

// ─── PJ自動生成（ルートB）───
function createPJAndEST({ projectName, customer, salesPerson, probability, deliveryDate, subtotal, salesRegion, notes, issueDate, status, productCode, productName, qty }) {
  const resolvedStatus = status || 'quoted';
  const taxAmount = salesRegion === 'JP' ? Math.floor(subtotal * 0.1) : 0;
  const total = subtotal + taxAmount;

  // 製品明細（製品名があれば1明細を生成）
  const products = productName ? [{
    productCode: productCode || '',
    productName: productName || '',
    qty:         parseInt(qty) || 1,
    currency:    'JPY',
    unitPrice:   qty && qty > 0 ? Math.floor(subtotal / (parseInt(qty)||1)) : subtotal,
    taxRate:     salesRegion === 'JP' ? 10 : 0,
    lineTotal:   subtotal,
    localAmount: subtotal,
  }] : [];

  const pjData = {
    projectName:  projectName || '',
    customer:     customer    || '',
    salesPerson:  salesPerson || '',
    probability:  parseInt(probability) || 50,
    deliveryDate: deliveryDate || '',
    salesRegion:  salesRegion  || 'JP',
    subtotal:     subtotal || 0,
    total,
    taxDetails:   salesRegion === 'JP' ? [{ taxRate: 10, taxBase: subtotal, taxAmount }] : [],
    products,
    memo:         notes || '',
    status:       resolvedStatus,
    latest_estimate_version: 1,
  };
  const savedPJ = LocalDB.saveProject(pjData);

  // ESTレコードを生成
  const today = issueDate || new Date().toISOString().slice(0,10);
  const estNo = 'EST-' + savedPJ.projectNo.replace('PJ-','') + '-01';
  const estRecord = {
    estimate_no: estNo,
    project_no:  savedPJ.projectNo,
    version:     1,
    issue_date:  today,
    valid_until: '',
    status:      resolvedStatus,
    notes:       notes || '',
    created_at:  new Date().toISOString(),
    approved_at: null,
    projectName: savedPJ.projectName,
    customer:    savedPJ.customer,
    customerCode:'',
    salesPerson: savedPJ.salesPerson,
    salesRegion: savedPJ.salesRegion,
    probability: savedPJ.probability,
    deliveryDate:savedPJ.deliveryDate,
    subtotal:    savedPJ.subtotal,
    total:       savedPJ.total,
    taxDetails:  savedPJ.taxDetails,
  };
  EstimateDB.save(estRecord);
  return { pj: savedPJ, est: estRecord };
}

// ─── Init ───
document.addEventListener('DOMContentLoaded', () => {
  loadEstimates();
  buildFilterOptions();
  applyFilters();
  setupDragDrop();
  updateMasterBadges();
});

function loadEstimates() {
  invalidatePJCache();
  allEstimates = EstimateDB.getAll().sort((a,b)=>
    new Date(b.created_at||b.issue_date) - new Date(a.created_at||a.issue_date)
  );
}

// ─── Filter & Sort ───
function applyFilters() {
  const q       = document.getElementById('searchInput').value.toLowerCase();
  const region  = document.getElementById('filterRegion').value;
  const sales   = document.getElementById('filterSales').value;
  const dateFrom= document.getElementById('filterDateFrom').value;
  const dateTo  = document.getElementById('filterDateTo').value;
  const prob    = document.getElementById('filterProb').value;

  filtered = allEstimates.filter(e => {
    if (q && ![ e.estimate_no, e.project_no, e.projectName, e.customer ].join('|').toLowerCase().includes(q)) return false;
    if (region && e.salesRegion !== region) return false;
    if (sales  && e.salesPerson !== sales)  return false;
    if (dateFrom && (e.issue_date||'') < dateFrom) return false;
    if (dateTo   && (e.issue_date||'') > dateTo)   return false;
    if (prob === 'high' && (e.probability||0) < 70) return false;
    if (prob === 'mid'  && ((e.probability||0) < 40 || (e.probability||0) >= 70)) return false;
    if (prob === 'low'  && (e.probability||0) >= 40) return false;
    return true;
  });

  // Sort
  filtered.sort((a,b) => {
    let va = a[sortKey] ?? ''; let vb = b[sortKey] ?? '';
    if (typeof va === 'string') { va=va.toLowerCase(); vb=vb.toLowerCase(); }
    if (va < vb) return sortDir==='asc' ? -1 : 1;
    if (va > vb) return sortDir==='asc' ? 1  : -1;
    return 0;
  });

  currentPage = 1;
  updateSummary();
  renderTable();
  renderPagination();
}

function sortBy(key) {
  if (sortKey === key) sortDir = sortDir==='asc' ? 'desc' : 'asc';
  else { sortKey = key; sortDir = 'desc'; }
  document.querySelectorAll('.sort-icon').forEach(el => el.textContent = '↕');
  const el = document.getElementById('sort_' + key);
  if (el) el.textContent = sortDir==='asc' ? '↑' : '↓';
  applyFilters();
}

function clearFilters() {
  document.getElementById('searchInput').value = '';
  document.getElementById('filterRegion').value = '';
  document.getElementById('filterSales').value = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  document.getElementById('filterProb').value = '';
  applyFilters();
}

function buildFilterOptions() {
  const regions = [...new Set(allEstimates.map(e=>e.salesRegion).filter(Boolean))].sort();
  const sales   = [...new Set(allEstimates.map(e=>e.salesPerson).filter(Boolean))].sort();
  const rSel = document.getElementById('filterRegion');
  regions.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; rSel.appendChild(o); });
  const sSel = document.getElementById('filterSales');
  sales.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sSel.appendChild(o); });
}

// ─── Summary ───
function updateSummary() {
  const count   = filtered.length;
  const total   = filtered.reduce((s,e)=>s+(e.subtotal||0),0);
  const wProb   = filtered.length > 0
    ? Math.round(filtered.reduce((s,e)=>s+((e.probability||0)*(e.subtotal||0)),0) / (total||1))
    : 0;

  document.getElementById('sumCount').textContent = count.toLocaleString('ja-JP');
  document.getElementById('sumTotal').textContent = total===0 ? '–' : (total/1e4).toFixed(0)+'万';

  if (filtered.length > 0) {
    document.getElementById('sumProb').textContent = wProb + '%';
  } else {
    document.getElementById('sumProb').textContent = '–';
  }

  const latest = filtered.map(e=>e.issue_date||'').filter(Boolean).sort().reverse()[0];
  document.getElementById('sumLatest').textContent = latest ? latest.slice(5).replace('-','/') : '–';
  document.getElementById('sumLatestLabel').textContent = latest ? latest.slice(0,4) + '年' : '–';

  document.getElementById('resultCount').textContent  = count;
  const showing = perPage===0 ? count : Math.min(perPage * currentPage, count) - (perPage*(currentPage-1));
  document.getElementById('showingCount').textContent = Math.max(0, Math.min(showing, count - perPage*(currentPage-1)));
}

// ─── Status Map ───
const STATUS_MAP = {
  draft:     { label: '見積前',   class: 'status-draft' },
  pending:   { label: '承認待ち', class: 'status-quoted' },
  quoted:    { label: '見積済',   class: 'status-quoted' },
  ordered:   { label: '受注済',   class: 'status-ordered' },
  delivered: { label: '納品済',   class: 'status-delivered' },
  invoiced:  { label: '請求済',   class: 'status-invoiced' },
  paid:      { label: '入金済',   class: 'status-paid' },
};

// ─── Render Table ───
function fmt(n) { return Math.floor(n).toLocaleString('ja-JP'); }
function fmtDate(d) { return d ? d.slice(0,10).replace(/-/g,'/') : '–'; }

// PJキャッシュ（renderTableのたびに全件取得するのを最適化）
let _pjCache = null;
function getPJMap() {
  if (!_pjCache) {
    _pjCache = new Map();
    LocalDB.getAllProjects().forEach(p => _pjCache.set(p.projectNo, p));
  }
  return _pjCache;
}
function invalidatePJCache() { _pjCache = null; }

function renderTable() {
  const tbody = document.getElementById('estTableBody');
  const start = perPage===0 ? 0 : (currentPage-1)*perPage;
  const end   = perPage===0 ? filtered.length : start + perPage;
  const page  = filtered.slice(start, end);

  if (page.length === 0) {
    tbody.innerHTML = `<tr><td colspan="17"><div class="empty-state">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg>
      <h3>${allEstimates.length === 0 ? '見積データがありません' : '条件に一致するデータがありません'}</h3>
      <p>${allEstimates.length === 0 ? '案件入力画面で「見積申請」を実行するか、CSVインポートで一括登録してください。' : '検索条件を変更してください。'}</p>
    </div></td></tr>`;
    syncCheckAll(page); return;
  }

  const CURRENCY_SYMBOL = { JPY: '¥', USD: '$', EUR: '€', RMB: '¥', CNY: '¥' };
  const today = new Date().toISOString().slice(0,10);
  const pjMap = getPJMap();

  // ESTレコードをPJの製品明細で展開（1EST = products数分の行）
  const displayRows = [];
  for (const e of page) {
    const pj = pjMap.get(e.project_no);
    const products = (pj && pj.products && pj.products.length > 0) ? pj.products : [null];
    products.forEach((prod, idx) => {
      displayRows.push({ est: e, prod, isFirst: idx === 0 });
    });
  }

  tbody.innerHTML = displayRows.map(({ est: e, prod, isFirst }) => {
    const statusCfg = STATUS_MAP[e.status] || { label: e.status || '–', class: 'status-draft' };
    const checked   = selectedRows.has(e.estimate_no) ? 'checked' : '';
    const prob      = e.probability || 0;
    const probColor = prob >= 70 ? '#1a8f5c' : prob >= 40 ? '#d97706' : '#d9503f';
    const probBg    = prob >= 70 ? '#edf8f2' : prob >= 40 ? '#fffbeb' : '#fdf0ee';

    let dateClass = 'td-date';
    const deliveryDate = e.deliveryDate || '';
    if (deliveryDate && deliveryDate < today) dateClass += ' date-overdue';

    const currency  = prod ? (prod.currency || 'JPY') : 'JPY';
    const isForeign = currency !== 'JPY';
    const sym       = CURRENCY_SYMBOL[currency] || (currency + ' ');
    const localAmt  = prod ? (prod.localAmount != null ? prod.localAmount : (prod.lineTotal || 0)) : null;

    const localAmountCell = (isForeign && localAmt != null)
      ? `<td style="text-align:right;white-space:nowrap;">${sym}${fmt(localAmt)}</td>`
      : `<td style="text-align:right;color:var(--text-tertiary);font-size:11px;">–</td>`;

    const noStyle  = isFirst ? '' : ` style="color:var(--text-tertiary);font-size:11px;"`;
    const rowStyle = isFirst ? '' : ` style="border-top:1px dashed var(--border-subtle);"`;
    const cbCell   = isFirst
      ? `<td onclick="event.stopPropagation()" style="padding:12px;"><input type="checkbox" class="row-checkbox" ${checked} onchange="toggleRow('${e.estimate_no}', this)"></td>`
      : `<td></td>`;

    return `<tr class="${selectedRows.has(e.estimate_no) ? 'selected-row' : ''}${isFirst ? '' : ' prod-subrow'}"${rowStyle}>
      ${cbCell}
      <td><a class="est-no-link" onclick="openEstimate('${e.project_no}')">${e.estimate_no}</a></td>
      <td><span class="proj-no-link" onclick="openProject('${e.project_no}')"${noStyle}>${e.project_no}</span></td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"${noStyle} title="${e.projectName||''}">${e.projectName||'–'}</td>
      <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${e.customer||''}">${e.customer||'–'}</td>
      <td><span class="status-badge ${statusCfg.class}">${statusCfg.label}</span></td>
      <td style="text-align:center;font-size:12px;">${e.salesRegion||'–'}</td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${prod?(prod.productName||''):''}">
        ${prod ? (prod.productName||'–') : '–'}</td>
      <td style="text-align:center;">${prod && prod.qty != null ? prod.qty.toLocaleString() : '–'}</td>
      <td style="text-align:center;"><span class="currency-badge" style="${isForeign ? 'background:#e8f0fe;color:#376ee6;' : ''}">${currency}</span></td>
      ${localAmountCell}
      <td style="text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap;">¥${fmt(e.subtotal||0)}</td>
      <td class="td-prob"><span class="prob-badge" style="background:${probBg};color:${probColor};">${prob}%</span></td>
      <td class="${dateClass}">${fmtDate(deliveryDate)}</td>
      <td style="max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${e.salesPerson||'–'}</td>
      <td class="td-date" style="white-space:nowrap;">${fmtDate(e.issue_date)}</td>
      <td style="text-align:center;"><span style="font-size:11px;background:var(--bg-tertiary);border-radius:4px;padding:2px 7px;font-family:Inter,monospace;">${String(e.version||1).padStart(2,'0')}</span></td>
    </tr>`;
  }).join('');

  syncCheckAll(page);
  updateBulkBar();
}

function syncCheckAll(page) {
  const el = document.getElementById('checkAll');
  if (!el) return;
  const pageNos = page.map(e => e.estimate_no);
  el.checked = pageNos.length > 0 && pageNos.every(no => selectedRows.has(no));
  el.indeterminate = !el.checked && pageNos.some(no => selectedRows.has(no));
}

function openEstimate(projectNo) {
  window.location.href = `案件入力画面_Phase2A_連携版.html?projectNo=${projectNo}`;
}
function openProject(projectNo) {
  window.location.href = `案件入力画面_Phase2A_連携版.html?projectNo=${projectNo}`;
}

// ─── Pagination ───
function renderPagination() {
  const pag = document.getElementById('pagination');
  if (perPage === 0 || filtered.length <= perPage) { pag.innerHTML=''; return; }
  const totalPages = Math.ceil(filtered.length / perPage);
  let html = `<button class="page-btn" ${currentPage<=1?'disabled':''} onclick="gotoPage(${currentPage-1})">‹</button>`;
  for (let p=1; p<=totalPages; p++) {
    if (totalPages<=7 || p===1 || p===totalPages || Math.abs(p-currentPage)<=1)
      html += `<button class="page-btn ${p===currentPage?'active':''}" onclick="gotoPage(${p})">${p}</button>`;
    else if (Math.abs(p-currentPage)===2)
      html += `<span style="padding:0 4px;color:var(--text-tertiary);">…</span>`;
  }
  html += `<button class="page-btn" ${currentPage>=totalPages?'disabled':''} onclick="gotoPage(${currentPage+1})">›</button>`;
  pag.innerHTML = html;
}
function gotoPage(p) { currentPage = p; renderTable(); renderPagination(); updateSummary(); window.scrollTo(0,0); }
function changePerPage() { perPage = parseInt(document.getElementById('perPageSelect').value); applyFilters(); }

// ─── Checkbox ───
function toggleCheckAll() {
  const all = document.getElementById('checkAll').checked;
  const start = perPage===0?0:(currentPage-1)*perPage;
  const end   = perPage===0?filtered.length:start+perPage;
  filtered.slice(start,end).forEach(e => {
    if (all) selectedRows.add(e.estimate_no); else selectedRows.delete(e.estimate_no);
  });
  renderTable();
}
function toggleRow(estNo, cb) { if(cb.checked) selectedRows.add(estNo); else selectedRows.delete(estNo); updateBulkBar(); }
function updateBulkBar() {
  const bar = document.getElementById('bulkBar');
  if (selectedRows.size > 0) { bar.classList.add('show'); document.getElementById('bulkCount').textContent=selectedRows.size; }
  else { bar.classList.remove('show'); }
}

// ─── Delete ───
function deleteSelected() {
  if (!selectedRows.size) return;
  if (!confirm(`${selectedRows.size}件の見積レコードを削除しますか？\n（案件レコードは削除されません）`)) return;
  selectedRows.forEach(no => EstimateDB.delete(no));
  selectedRows.clear();
  loadEstimates();
  buildFilterOptionsRefresh();
  applyFilters();
  showToast(`${selectedRows.size}件を削除しました`, 'success');
}

function buildFilterOptionsRefresh() {
  const rSel = document.getElementById('filterRegion');
  const sSel = document.getElementById('filterSales');
  const rVal = rSel.value; const sVal = sSel.value;
  while(rSel.options.length>1) rSel.remove(1);
  while(sSel.options.length>1) sSel.remove(1);
  const regions = [...new Set(allEstimates.map(e=>e.salesRegion).filter(Boolean))].sort();
  const sales   = [...new Set(allEstimates.map(e=>e.salesPerson).filter(Boolean))].sort();
  regions.forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; rSel.appendChild(o); });
  sales.forEach(s => { const o=document.createElement('option'); o.value=s; o.textContent=s; sSel.appendChild(o); });
  rSel.value=rVal; sSel.value=sVal;
}

// ─── CSV エクスポート ───
// ─── 為替レートキャッシュ（案件一覧と同一ロジック） ───
let fxAllRatesCache = new Map();
function loadFxRates() {
  try {
    const fxData = JSON.parse(localStorage.getItem('qururi:exchange_rates') || '[]');
    fxAllRatesCache = new Map();
    fxData.forEach(r => {
      const cc = String(r.currency || '').toUpperCase();
      const ym = String(r.year_month || '').slice(0, 7);
      if (cc && ym && r.rate_avg != null) fxAllRatesCache.set(cc + ':' + ym, Number(r.rate_avg));
    });
  } catch { fxAllRatesCache = new Map(); }
}
function getFxRate(currency, deliveryDate, fxAllRates) {
  if (!currency || currency === 'JPY') return 1;
  if (!deliveryDate) return null;
  const ym = String(deliveryDate).slice(0, 7);
  const rate = fxAllRates.get(currency.toUpperCase() + ':' + ym);
  return (rate != null) ? rate : null;
}

// ─── CSV エクスポート（案件一覧と同一の29列 + EST固有3列 = 32列） ───
function exportCSV() {
  if (!filtered.length) { showToast('エクスポートするデータがありません', 'error'); return; }
  loadFxRates();
  const csv = buildEstCSV(filtered);
  downloadCSV(csv, 'QURURi_見積一覧_' + todayStr() + '.csv');
  const lineCount = filtered.reduce((s, e) => {
    const pj = getPJMap().get(e.project_no);
    return s + (pj?.products?.length || 1);
  }, 0);
  showToast(filtered.length + '件（' + lineCount + '明細行）をエクスポートしました', 'success');
}
function exportSelectedCSV() {
  const rows = filtered.filter(e => selectedRows.has(e.estimate_no));
  if (!rows.length) { showToast('行を選択してください', 'error'); return; }
  loadFxRates();
  const csv = buildEstCSV(rows);
  downloadCSV(csv, 'QURURi_見積一覧_選択分_' + todayStr() + '.csv');
  showToast(rows.length + '件をエクスポートしました', 'success');
}

function buildEstCSV(estRows) {
  // EST番号昇順に強制ソート
  const sorted = [...estRows].sort((a, b) =>
    String(a.estimate_no) < String(b.estimate_no) ? -1 : 1
  );

  // 製品マスタMap（大区分・中区分・小区分の取得用）
  let prodMasterMap = new Map();
  try {
    const pm = JSON.parse(localStorage.getItem('qururi:products') || '[]');
    pm.forEach(r => prodMasterMap.set(String(r.product_code || ''), r));
  } catch(e) {}

  const pjMap = getPJMap();

  // ヘッダー: EST固有3列 + 案件一覧29列と同一
  const headers = [
    'EST番号', '版', '申請日',
    '案件No', '案件名', '取引先コード', '取引先', '担当者コード', '担当者',
    '販売地域', '業界', '商流', '自社セグ',
    'ステータス',
    '製品コード', '製品名', '大区分', '中区分', '小区分',
    '数量', '通貨', '税抜単価（現地通貨）', '税率',
    '明細金額（外貨）', '為替レート', '明細金額（円貨）',
    '合計金額（税抜）',
    '受注確度(%)', '納品予定日', '備考', '登録日時', '更新日時'
  ];

  const dataRows = [];
  sorted.forEach(e => {
    const p = pjMap.get(e.project_no) || {};
    const statusLabel = STATUS_MAP[e.status]?.label || e.status || '';
    const products = (p.products && p.products.length > 0) ? p.products : [null];

    products.forEach(prod => {
      const masterRec = prod ? prodMasterMap.get(String(prod.productCode || '')) : null;
      const cur = prod ? (prod.currency || 'JPY') : 'JPY';
      const isFx = cur !== 'JPY';
      const rate = isFx ? getFxRate(cur, e.deliveryDate, fxAllRatesCache) : null;

      // 明細金額（円貨）
      const lineJpy = (() => {
        if (!prod) return '';
        if (!isFx) return prod.lineTotal != null ? prod.lineTotal : 0;
        return (rate != null && prod.lineTotal != null) ? Math.round(prod.lineTotal * rate) : '';
      })();

      dataRows.push([
        // EST固有
        e.estimate_no || '',
        String(e.version || 1).padStart(2, '0'),
        e.issue_date   || '',
        // 案件基本
        e.project_no   || '',
        e.projectName  || '',
        p.customerCode || '',
        e.customer     || '',
        p.staffCode    || '',
        e.salesPerson  || '',
        e.salesRegion  || '',
        p.industry     || '',
        p.channel      || '',
        p.segment      || '',
        statusLabel,
        // 製品明細
        prod ? (prod.productCode || '') : '',
        prod ? (prod.productName || '') : '',
        masterRec?.category_l || '',
        masterRec?.category_m || '',
        masterRec?.category_s || '',
        prod ? (prod.qty != null ? prod.qty : 1) : '',
        prod ? cur : '',
        prod ? (prod.unitPrice != null ? prod.unitPrice : 0) : '',
        prod ? (prod.taxRate   != null ? prod.taxRate   : '') : '',
        // 外貨明細金額（JPYは空）
        (isFx && prod?.localAmount != null) ? prod.localAmount : '',
        // 為替レート（JPYは空）
        (isFx && rate != null) ? rate : '',
        lineJpy,
        // 合計・確度・納品日・備考・日時
        e.subtotal     || 0,
        e.probability  || 0,
        e.deliveryDate || '',
        e.notes        || '',
        p.createdAt    || '',
        p.updatedAt    || '',
      ]);
    });
  });

  const esc = v => '"' + String(v).replace(/"/g, '""') + '"';
  const lines = [headers, ...dataRows].map(row => row.map(esc).join(','));
  return '\uFEFF' + lines.join('\r\n');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename; a.click();
  URL.revokeObjectURL(a.href);
}
function todayStr() { return new Date().toISOString().slice(0,10).replace(/-/g,''); }

function downloadTemplate() {
  const lines = [
    '\uFEFF# 【QURURi 見積インポートひな形】',
    '# ─────────────────────────────────────────────────────────',
    '# 【コードと名前の使い分け】',
    '#   取引先コード / 担当者コード / 製品コード が入力されている場合は優先して照合します',
    '#   コードが空の場合は取引先名 / 担当者名 / 製品名 でフォールバック照合します',
    '#   ※ 取引先コードと取引先名のどちらか一方は必須です',
    '# 【数量】製品1行あたりの数量を整数で入力してください（省略時は1として扱います）',
    '# 【地域】CSVへの入力不要。取引先マスタから自動引き継ぎされます',
    '# ─────────────────────────────────────────────────────────',
    '# 【ステータスの入力値】',
    '#   見積前=draft  見積済=quoted  受注済=ordered  納品済=delivered  請求済=invoiced  入金済=paid',
    '# 【納品予定日の形式】YYYY-MM-DD（例: 2026-06-30）またはYYYY/MM/DD形式も可',
    '# ※「#」で始まる行は読み込み時に自動的に無視されます',
    '# ※ 次のヘッダー行の次の行からデータを入力してください',
    '# ─────────────────────────────────────────────────────────',
    '案件名,取引先コード,取引先名,担当者コード,担当者名,製品コード,製品名,数量,納品予定日,受注確度,ステータス,金額,備考',
    '"山田製作所 検査装置 2026","1001","山田製作所","E001","佐藤 健一","P101","検査装置 TypeA","1","2026-07-25","70","quoted","12000000","CSV直接入力"',
    '"ABC Electronics センサー","","ABC Electronics","","田中 花子","P102","センサーユニット","2","2026-09-30","50","quoted","","金額ブランク→単価マスタから自動算出"',
    '"東芝エネルギー案件","","東芝エネルギー","","渡辺 武","","","1","2026-12-31","40","quoted","","コード不明な場合は名前欄に入力"',
  ];
  downloadCSV(lines.join('\n'), 'QURURi_見積インポートひな形.csv');
}

// ─── CSV インポート ───
function openImportModal() {
  document.getElementById('importModal').classList.add('open');
  document.getElementById('importPreview').style.display='none';
  document.getElementById('importExecuteBtn').disabled=true;
  document.getElementById('csvFileInput').value='';
  parsedCsvRows=[];
}
function closeImportModal() { document.getElementById('importModal').classList.remove('open'); }

function setupDragDrop() {
  const zone = document.getElementById('uploadZone');
  zone.addEventListener('dragover', e=>{e.preventDefault();zone.classList.add('drag-over');});
  zone.addEventListener('dragleave', ()=>zone.classList.remove('drag-over'));
  zone.addEventListener('drop', e=>{
    e.preventDefault(); zone.classList.remove('drag-over');
    const f=e.dataTransfer.files[0]; if(f) processCSVFile(f);
  });
}

function handleFileSelect(e) { const f=e.target.files[0]; if(f) processCSVFile(f); }

function processCSVFile(file) {
  const reader = new FileReader();
  reader.onload = ev => {
    const text = ev.target.result.replace(/^\uFEFF/,'');
    // #コメント行を除去
    const cleaned = text.split(/\r?\n/).filter(l=>!l.trim().startsWith('#')).join('\n');
    parsedCsvRows = parseCSV(cleaned);
    const prev = document.getElementById('importPreview');
    const title = document.getElementById('previewTitle');
    const content = document.getElementById('previewContent');
    if (parsedCsvRows.length===0) {
      title.textContent = 'エラー: 有効な行が見つかりません';
      content.textContent = text.slice(0,500);
    } else {
      title.textContent = `${parsedCsvRows.length}件を検出。内容を確認してからインポートを実行してください。`;
      content.textContent = parsedCsvRows.slice(0,5).map(r=>JSON.stringify(r)).join('\n') + (parsedCsvRows.length>5?'\n...':'');
      document.getElementById('importExecuteBtn').disabled=false;
    }
    prev.style.display='block';
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if (lines.length < 2) return [];
  const headers = splitCSVLine(lines[0]).map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const vals = splitCSVLine(line);
    const row = {};
    headers.forEach((h,i)=>{ row[h]=vals[i]?.trim()||''; });
    return row;
  }).filter(r=>Object.values(r).some(v=>v));
}

function splitCSVLine(line) {
  const result=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const c=line[i];
    if(c==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
    else if(c===','&&!inQ){result.push(cur);cur='';}
    else cur+=c;
  }
  result.push(cur); return result;
}

function normalizeDate(str) {
  if (!str) return '';
  str = str.trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(str)) return str;
  let m = str.match(/^(\d{4})[\/](\d{1,2})[\/](\d{1,2})$/);
  if (m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
  m = str.match(/^(\d{1,2})[\/](\d{1,2})[\/](\d{4})$/);
  if (m) return `${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`;
  return str;
}

function executeImport() {
  if (!parsedCsvRows.length) return;
  let success=0, errors=[];
  parsedCsvRows.forEach((row,i)=>{
    const projectName = row['案件名']||'';
    const customer    = row['取引先名']||row['取引先']||'';
    if (!projectName) { errors.push(`行${i+2}: 案件名が空`); return; }
    // 金額：「金額」列を優先、次に「合計金額（税抜）」
    const subtotal = parseFloat(String(row['金額']||row['合計金額（税抜）']||'0').replace(/,/g,''))||0;
    try {
      createPJAndEST({
        projectName,
        customer,
        salesPerson:  row['担当者名']||row['担当者']||'',
        probability:  parseInt(row['受注確度'])||50,
        deliveryDate: normalizeDate(row['納品予定日']||''),
        subtotal,
        salesRegion:  row['販売地域']||'JP',
        notes:        row['備考']||'',
        issueDate:    normalizeDate(row['申請日']||'')||new Date().toISOString().slice(0,10),
        status:       row['ステータス']||'quoted',
        // 製品明細（案件ひな形と同一列）
        productCode:  row['製品コード']||'',
        productName:  row['製品名']||'',
        qty:          parseInt(row['数量'])||1,
      });
      success++;
    } catch(e) { errors.push(`行${i+2}: ${e.message}`); }
  });
  closeImportModal();
  invalidatePJCache();
  loadEstimates();
  buildFilterOptionsRefresh();
  applyFilters();
  updateMasterBadges();
  if (errors.length) showToast(`${success}件登録 / ${errors.length}件エラー`, 'error', 5000);
  else showToast(`${success}件の見積を登録しました（PJ自動生成）`, 'success');
}

// ─── サイドバー マスター件数バッジ更新 ───
function updateMasterBadges() {
  const MASTERS = [
    { key: 'qururi:products',       id: 'sidebar-badge-products' },
    { key: 'qururi:prices',         id: 'sidebar-badge-prices' },
    { key: 'qururi:exchange_rates', id: 'sidebar-badge-exchange_rates' },
    { key: 'qururi:customers',      id: 'sidebar-badge-customers' },
    { key: 'qururi:staff',          id: 'sidebar-badge-staff' },
  ];
  MASTERS.forEach(m => {
    const el = document.getElementById(m.id);
    if (!el) return;
    try {
      const data = JSON.parse(localStorage.getItem(m.key) || '[]');
      const count = Array.isArray(data) ? data.length : 0;
      if (count > 0) { el.textContent = count.toLocaleString(); el.style.display = 'inline-block'; }
      else { el.style.display = 'none'; }
    } catch(e) { el.style.display = 'none'; }
  });
}

// ─── Toast ───
function showToast(message, type='success', duration=3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className='toast '+type;
  toast.innerHTML='<span class="toast-icon">'+(type==='success'?'✓':'✕')+'</span>'
                 +'<span>'+message+'</span>';
  container.appendChild(toast);
  requestAnimationFrame(()=>requestAnimationFrame(()=>toast.classList.add('show')));
  setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),250);},duration);
}
</script>
</body>
</html>
